C51 COMPILER V9.00   SYSTEM                                                                11/21/2017 19:14:30 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE SYSTEM
OBJECT MODULE PLACED IN ..\output\System.obj
COMPILER INVOKED BY: D:\keil\keillc51\keillc51set\C51\BIN\C51.EXE ..\program\System.c BROWSE INCDIR(..\program) DEBUG OB
                    -JECTEXTEND PRINT(..\listing\System.lst) TABS(2) OBJECT(..\output\System.obj)

line level    source

   1          #include"system.h"
   2          #include"lcd12864.h"
   3          #include"Delay.H"
   4          #include"key.h"
   5          #include"buzzer.h"
   6          #include"pid.h"
   7          #include"pwm.h"
   8          
   9          int flag=0,diatance_buf;
  10          /**************************显示页面*****************************/
  11          uchar xdata Display[5][4][17]={
  12            {                                         
  13              {"init"},{"  小球控制系统"},{"  "},{" "}                //第一页
  14            },
  15            {
  16              {"  Set_distance"},{"Expect:00"},{"Distance:   cm"},{"            next"}            //第二页
  17            },
  18            {
  19              {"  Action1"},{"32"},{"33"},{"back        next"}        //第三页
  20            },
  21            {
  22              {"  Action2"},{"42"},{"43  "},{"back        next"}            //第四页
  23            },
  24            {
  25              {"  Action3"},{"52"},{"53"},{"back        next"}        //第三页
  26            },
  27          };
  28          uchar key_value[5]={0};//存放键值
  29          char set_buff;//存放设置的距离值
  30          int actual_dis,dis;//实际距离和实际距离的附属变量
  31          /**************************************************************/
  32          
  33          State System_State=0;//系统状态的枚举变量
  34          Refresh System_refresh ={20,0,5,10,15};//系统各刷新时间结构体初始化T = 20ms
  35          /****************************************************************
  36          /*函数名：void Set_Distance()     
  37          /*功能：  实现距离设定和控制
  38          /*说明：
  39          /*修改日期：2017-11-12
  40          /*作者：c.c. 
  41          /***************************************************************/
  42          void Set_Distance()
  43          {
  44   1        int i=0,key_flag=0;
  45   1        key_value[0]=KEY4_scan();//将键值读入输入流
  46   1      
  47   1        switch(key_value[0])
  48   1        {
  49   2          case 1:
  50   2          {
  51   3            System_State = init;
  52   3            Write_comordata(0,0x01);
  53   3          }break;
  54   2          case 2:
C51 COMPILER V9.00   SYSTEM                                                                11/21/2017 19:14:30 PAGE 2   

  55   2          {
  56   3            if(set_buff==0)                   //0-16
  57   3                set_buff=41;
  58   3            set_buff--;
  59   3            Display[1][1][8]='0'+(set_buff)%10; //0
  60   3            Display[1][1][7]='0'+(set_buff)/10; //10
  61   3      
  62   3          }break;
  63   2          case 3:
  64   2          {
  65   3            set_buff++;
  66   3            if(set_buff==41)                  //16-0
  67   3              set_buff=0;
  68   3            Display[1][1][8]='0'+(set_buff)%10; //0
  69   3            Display[1][1][7]='0'+(set_buff)/10; //10
  70   3          }break; 
  71   2          case 4:
  72   2          {
  73   3                                    //在此循环中添加控制函数
  74   3            actual_dis = 15;
  75   3      /**/    PID_setpara(1,0,0);//参数：比例系数，积分系数，微分系数
  76   3            while(1)
  77   3            {
  78   4              if(actual_dis != diatance_buf)//距离改变时，改变PWM
  79   4              {
  80   5      //          PID_Calculate(actual_dis,set_buff,0);
  81   5                PWM2_set(PID_Calculate(actual_dis,set_buff,0));
  82   5                diatance_buf=actual_dis;//同步 
  83   5              }
  84   4      
  85   4              if(actual_dis>0)
  86   4              { 
  87   5                Display[1][2][9]='+'; //0                                                                            
             -                                                                                                                        
             -                                                                            
  88   5                Display[1][2][11]='0'+actual_dis%10;  //0
  89   5                Display[1][2][10]='0'+actual_dis/10;  //10
  90   5              }
  91   4              else
  92   4              {
  93   5                dis = -actual_dis;
  94   5                Display[1][2][9]='-'; //0
  95   5                Display[1][2][11]='0'+dis%10; //0
  96   5                Display[1][2][10]='0'+dis/10; //10
  97   5              }
  98   4      
  99   4              LCD12864_Display(3,&Display[1][2][0]);
 100   4              if(KEY4_scan()==4)
 101   4                break;
 102   4            }
 103   3            System_State = action1;
 104   3            Write_comordata(0,0x01);
 105   3          }break;
 106   2          default:break;
 107   2        }
 108   1      }
 109          
 110          /****************************************************************
 111          /*函数名：void Action1()      
 112          /*功能：
 113          /*说明：
 114          /*修改日期：2017-11-12
C51 COMPILER V9.00   SYSTEM                                                                11/21/2017 19:14:30 PAGE 3   

 115          /*作者：c.c. 
 116          /***************************************************************/
 117          void Action1()
 118          {
 119   1        key_value[0]=KEY4_scan();//将键值读入输入流
 120   1        switch(key_value[0])
 121   1        {
 122   2          case 1:
 123   2          {
 124   3            System_State = set_distance;
 125   3            Write_comordata(0,0x01);
 126   3            key_value[1]=0;
 127   3          }break;
 128   2          case 2:
 129   2          {
 130   3            ;
 131   3          }break;
 132   2          case 3:
 133   2          {
 134   3            ;
 135   3          }break;
 136   2          case 4:
 137   2          {
 138   3              System_State = action2;
 139   3      //        Write_comordata(0,0x01);
 140   3          }break;
 141   2          default:break;
 142   2        }
 143   1      }
 144          
 145          /****************************************************************
 146          /*函数名：void Action2()    
 147          /*功能：
 148          /*说明：
 149          /*修改日期：2017-11-12
 150          /*作者：c.c. 
 151          /***************************************************************/
 152          void Action2()
 153          {
 154   1        key_value[0]=KEY4_scan();//将键值读入输入流
 155   1        switch(key_value[0])
 156   1        {
 157   2          case 1:
 158   2          {
 159   3            System_State = action1;
 160   3      //      Write_comordata(0,0x01);
 161   3            key_value[1]=0;
 162   3          }break;
 163   2          case 2:
 164   2          {
 165   3            ;
 166   3          }break;
 167   2          case 3:
 168   2          {
 169   3            ;
 170   3          }break;
 171   2          case 4:
 172   2          {
 173   3      //        Display[4][1][0]='0'+flag/10;
 174   3      //        Display[4][1][1]='0'+flag%10;
 175   3              LCD12864_Display(2,&Display[4][1][0]);
 176   3              System_State = action3;
C51 COMPILER V9.00   SYSTEM                                                                11/21/2017 19:14:30 PAGE 4   

 177   3      //        Write_comordata(0,0x01);
 178   3          }break;
 179   2          default:break;
 180   2        }
 181   1      }
 182          
 183          /****************************************************************
 184          /*函数名：void Action3()      
 185          /*功能：
 186          /*说明：
 187          /*修改日期：2017-11-12
 188          /*作者：c.c. 
 189          /***************************************************************/
 190          void Action3()
 191          {
 192   1        key_value[0]=KEY4_scan();//将键值读入输入流
 193   1        switch(key_value[0])
 194   1        {
 195   2          case 1:
 196   2          {
 197   3            System_State = action2;
 198   3      //      Write_comordata(0,0x01);
 199   3            key_value[1]=0;
 200   3          }break;
 201   2          case 2:
 202   2          {
 203   3            ;
 204   3          }break;
 205   2          case 3:
 206   2          {
 207   3            ;
 208   3          }break;
 209   2          case 4:
 210   2          {
 211   3            System_State = init;
 212   3      //      Write_comordata(0,0x01);
 213   3          }break;
 214   2          default:break;
 215   2        }
 216   1      }
 217          
 218          /****************************************************************
 219          /*函数名：void System()     
 220          /*功能：  系统函数
 221          /*说明：
 222          /*修改日期：2017-11-12
 223          /*作者：c.c. 
 224          /***************************************************************/
 225          void System()
 226          {
 227   1        switch(System_State)
 228   1        {
 229   2          case init:
 230   2          {
 231   3            Write_comordata(0,0x01);                //清屏
 232   3            Delay(5);
 233   3            LCD12864_Display(1,&Display[0][1][0]);  //开机页面
 234   3            Delay(1000);
 235   3            Write_comordata(0,0x01);                //清屏
 236   3            Delay(5);
 237   3            System_State=set_distance;
 238   3          }break;
C51 COMPILER V9.00   SYSTEM                                                                11/21/2017 19:14:30 PAGE 5   

 239   2          case set_distance:
 240   2          {
 241   3            if(System_refresh.set_Distance_fresh>System_refresh.T)//每20ms扫描一次
 242   3            {
 243   4      //        EA = 0;
 244   4              Delay(100);
 245   4              LCD12864_Display(1,&Display[1][0][0]);
 246   4              LCD12864_Display(2,&Display[1][1][0]);
 247   4              LCD12864_Display(3,&Display[1][2][0]);
 248   4              LCD12864_Display(4,&Display[1][3][0]);
 249   4              System_refresh.set_Distance_fresh=0;
 250   4              Delay(100);
 251   4      //        EA = 1;
 252   4            }
 253   3              Set_Distance();
 254   3          }break;
 255   2          case action1:
 256   2          {
 257   3            if(System_refresh.action1_fresh>System_refresh.T)//每20ms扫描一次
 258   3            {
 259   4      //        EA = 0;
 260   4              LCD12864_Display(1,&Display[2][0][0]);
 261   4              LCD12864_Display(2,&Display[2][1][0]);
 262   4              LCD12864_Display(3,&Display[2][2][0]);
 263   4              LCD12864_Display(4,&Display[2][3][0]);
 264   4              System_refresh.action1_fresh=0;
 265   4      //        EA = 1;
 266   4            }
 267   3            Action1();
 268   3          }break;
 269   2          case action2:
 270   2          {
 271   3            if(System_refresh.action2_fresh>System_refresh.T)//每20ms扫描一次
 272   3            {
 273   4      //        EA = 0;
 274   4              LCD12864_Display(1,&Display[3][0][0]);
 275   4              LCD12864_Display(2,&Display[3][1][0]);
 276   4              LCD12864_Display(3,&Display[3][2][0]);
 277   4              LCD12864_Display(4,&Display[3][3][0]);      
 278   4              System_refresh.action2_fresh=0;
 279   4      //        EA = 1;
 280   4            }
 281   3            Action2();
 282   3          }break;
 283   2          case action3:
 284   2          {
 285   3            if(System_refresh.action3_fresh>System_refresh.T)//每20ms扫描一次
 286   3            {
 287   4      //        EA = 0;
 288   4              LCD12864_Display(1,&Display[4][0][0]);
 289   4              LCD12864_Display(2,&Display[4][1][0]);
 290   4              LCD12864_Display(3,&Display[4][2][0]);
 291   4              LCD12864_Display(4,&Display[4][3][0]);
 292   4      
 293   4              Display[4][1][0]='0'+flag/10;
 294   4              Display[4][1][1]='0'+flag%10;
 295   4      
 296   4              System_refresh.action3_fresh=0;
 297   4      //        EA = 1;
 298   4              P01=~P01;
 299   4            }
 300   3            Action3();
C51 COMPILER V9.00   SYSTEM                                                                11/21/2017 19:14:30 PAGE 6   

 301   3          }break;
 302   2          default :break;
 303   2        }
 304   1      }
 305          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    754    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    340    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     20       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
